{% extends "layout.html" %}

{% block title %}Scan Progress{% endblock %}

{% block content %}
<div class="progress-container">
    <!-- Target Header -->
    <div class="progress-header">
        <div class="target-display">
            <i class="fa-solid fa-crosshairs"></i>
            <div>
                <h2 id="target-name">Loading...</h2>
                <p class="scan-id-display">Scan ID: <code id="scan-id-display">{{ scan_id }}</code></p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline btn-sm" onclick="window.location.href='/scans/history'">
                <i class="fa-solid fa-list"></i>
                View All Scans
            </button>
        </div>
    </div>

    <!-- Phase Tracker -->
    <div class="phase-tracker-card">
        <h3 class="card-heading">
            <i class="fa-solid fa-diagram-project"></i>
            Scan Pipeline
        </h3>
        <div class="phase-tracker">
            <div class="phase-item" data-phase="validation">
                <div class="phase-icon">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
                <div class="phase-label">Validation</div>
                <div class="phase-status">Pending</div>
            </div>

            <div class="phase-connector"></div>

            <div class="phase-item" data-phase="nmap">
                <div class="phase-icon">
                    <i class="fa-solid fa-network-wired"></i>
                </div>
                <div class="phase-label">Nmap Scan</div>
                <div class="phase-status">Pending</div>
            </div>

            <div class="phase-connector"></div>

            <div class="phase-item" data-phase="nuclei">
                <div class="phase-icon">
                    <i class="fa-solid fa-bug"></i>
                </div>
                <div class="phase-label">Nuclei Scan</div>
                <div class="phase-status">Pending</div>
            </div>

            <div class="phase-connector"></div>

            <div class="phase-item" data-phase="ai">
                <div class="phase-icon">
                    <i class="fa-solid fa-brain"></i>
                </div>
                <div class="phase-label">AI Analysis</div>
                <div class="phase-status">Pending</div>
            </div>

            <div class="phase-connector"></div>

            <div class="phase-item" data-phase="complete">
                <div class="phase-icon">
                    <i class="fa-solid fa-flag-checkered"></i>
                </div>
                <div class="phase-label">Complete</div>
                <div class="phase-status">Pending</div>
            </div>
        </div>

        <!-- Overall Progress Bar -->
        <div class="overall-progress">
            <div class="progress-info">
                <span class="progress-label">Overall Progress</span>
                <span class="progress-percentage" id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="progress-grid">
        <!-- Live Logs -->
        <div class="logs-card">
            <div class="card-header">
                <h3 class="card-heading">
                    <i class="fa-solid fa-terminal"></i>
                    Live Scan Output
                </h3>
                <div class="card-actions">
                    <button class="btn-icon" id="auto-scroll-toggle" title="Toggle auto-scroll">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>
                    <button class="btn-icon" id="clear-logs" title="Clear logs">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="logs-viewer" id="logs-viewer">
                <div class="log-entry log-info">
                    <span class="log-time">[--:--:--]</span>
                    <span class="log-message">Initializing scan...</span>
                </div>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <!-- Current Stats -->
            <div class="stat-card">
                <h4 class="stat-title">
                    <i class="fa-solid fa-clock"></i>
                    Elapsed Time
                </h4>
                <div class="stat-value" id="elapsed-time">00:00</div>
            </div>

            <div class="stat-card">
                <h4 class="stat-title">
                    <i class="fa-solid fa-door-open"></i>
                    Open Ports
                </h4>
                <div class="stat-value" id="open-ports">0</div>
            </div>

            <div class="stat-card">
                <h4 class="stat-title">
                    <i class="fa-solid fa-bug"></i>
                    Vulnerabilities
                </h4>
                <div class="stat-value" id="vulnerabilities-found">0</div>
            </div>

            <div class="stat-card">
                <h4 class="stat-title">
                    <i class="fa-solid fa-gauge-high"></i>
                    Risk Score
                </h4>
                <div class="stat-value" id="current-risk">-</div>
            </div>

            <!-- Severity Breakdown -->
            <div class="severity-breakdown">
                <h4 class="breakdown-title">Severity Breakdown</h4>
                <div class="severity-item">
                    <span class="severity-label">
                        <span class="severity-dot critical"></span>
                        Critical
                    </span>
                    <span class="severity-count" id="count-critical">0</span>
                </div>
                <div class="severity-item">
                    <span class="severity-label">
                        <span class="severity-dot high"></span>
                        High
                    </span>
                    <span class="severity-count" id="count-high">0</span>
                </div>
                <div class="severity-item">
                    <span class="severity-label">
                        <span class="severity-dot medium"></span>
                        Medium
                    </span>
                    <span class="severity-count" id="count-medium">0</span>
                </div>
                <div class="severity-item">
                    <span class="severity-label">
                        <span class="severity-dot low"></span>
                        Low
                    </span>
                    <span class="severity-count" id="count-low">0</span>
                </div>
            </div>

            <!-- Connection Status -->
            <div class="connection-status">
                <div class="status-indicator" id="connection-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Actions (Hidden initially) -->
    <div class="completion-actions" id="completion-actions" style="display: none;">
        <div class="completion-message">
            <i class="fa-solid fa-circle-check"></i>
            <h3 id="completion-title">Scan Complete!</h3>
            <p id="completion-description">Your vulnerability scan has finished successfully.</p>
        </div>
        <div class="action-buttons">
            <button class="btn btn-primary btn-lg" id="view-report-btn">
                <i class="fa-solid fa-file-lines"></i>
                View Full Report
            </button>
            <button class="btn btn-outline" onclick="window.location.href='/scans/new'">
                <i class="fa-solid fa-plus"></i>
                New Scan
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Pass scan_id to JavaScript
    window.SCAN_ID = "{{ scan_id }}";
</script>
<script src="/static/js/scan_progress.js"></script>
{% endblock %}